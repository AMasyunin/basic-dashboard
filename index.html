<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Navixy Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script>
  <link rel="stylesheet" href="tokens.css">
  <style>
    /* ── Reset ── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-family); background: var(--bg); color: var(--text); min-height: 100vh; font-size: var(--font-size-base); }

    /* ── Header ── */
    .header { background: var(--header-bg); color: var(--header-color); padding: 0 var(--space-6); height: 56px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: var(--z-header); border-bottom: 1px solid var(--header-border); box-shadow: var(--shadow-xs); }
    .header-left { display: flex; align-items: center; gap: var(--space-3); }
    .header-logo { width: 32px; height: 32px; background: var(--primary); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-weight: var(--font-weight-extrabold); font-size: var(--font-size-lg); color: var(--color-white); }
    .header-title { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); color: var(--header-color); }
    .header-right { display: flex; align-items: center; gap: var(--space-2); }
    .header-meta { font-size: var(--font-size-xs); color: var(--text-secondary); }
    .user-badge { display: flex; align-items: center; gap: var(--space-1); font-size: var(--font-size-md); color: var(--text-secondary); }
    .server-badge { background: var(--primary-light); color: var(--primary); padding: 2px var(--space-2); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); letter-spacing: var(--letter-spacing-label); }

    /* ── Buttons ── */
    .btn { display: inline-flex; align-items: center; gap: var(--space-1); padding: 6px 14px; border-radius: var(--radius-sm); border: 1px solid transparent; cursor: pointer; font-size: var(--font-size-md); font-weight: var(--font-weight-medium); transition: all var(--transition-fast); line-height: 1; }
    .btn-ghost { background: transparent; border-color: var(--border); color: var(--text); }
    .btn-ghost:hover { background: var(--color-gray-50); }
    .btn-edit { background: transparent; border-color: var(--edit-accent); color: var(--edit-accent); }
    .btn-edit:hover { background: var(--edit-hover); }
    .btn-edit.active { background: var(--edit-accent); color: var(--color-white); border-color: var(--edit-accent); }
    .btn-primary { background: var(--primary); color: var(--color-white); border-color: var(--primary); }
    .btn-primary:hover { background: var(--color-blue-800); }
    .btn-danger { background: var(--danger-light); color: var(--danger); border-color: var(--danger-light); }
    .btn-danger:hover { background: var(--color-red-100); }
    .btn:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinning { animation: spin .8s linear infinite; }

    /* ── Setup screen ── */
    .setup-screen { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 56px); padding: var(--space-8) var(--space-6); text-align: center; }
    .setup-screen.visible { display: flex; }
    .setup-icon { width: 72px; height: 72px; border-radius: var(--radius-full); background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-5); }
    .setup-title { font-size: 22px; font-weight: var(--font-weight-bold); margin-bottom: var(--space-2); }
    .setup-desc { color: var(--text-secondary); max-width: 520px; line-height: var(--line-height-loose); margin-bottom: var(--space-7); }
    .setup-box { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border); padding: var(--space-7) var(--space-8); max-width: 560px; width: 100%; text-align: left; }
    .setup-box h3 { font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4); }
    .setup-step { display: flex; gap: var(--space-3); margin-bottom: 14px; font-size: var(--font-size-md); line-height: var(--line-height-normal); }
    .setup-num { flex-shrink: 0; width: 22px; height: 22px; border-radius: var(--radius-full); background: var(--primary); color: var(--color-white); display: flex; align-items: center; justify-content: center; font-size: var(--font-size-xs); font-weight: var(--font-weight-bold); }
    .setup-code { background: var(--color-gray-50); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 2px var(--space-1); font-family: monospace; font-size: var(--font-size-sm); word-break: break-all; }

    /* ── Edit mode bar ── */
    .edit-bar { display: none; background: var(--edit-bg); border-bottom: 2px solid var(--edit-accent); padding: var(--space-2) var(--space-6); align-items: center; justify-content: space-between; gap: var(--space-3); position: sticky; top: 56px; z-index: var(--z-edit-bar); }
    .edit-bar.visible { display: flex; }
    .edit-bar-info { font-size: var(--font-size-md); color: var(--edit-accent); font-weight: var(--font-weight-medium); display: flex; align-items: center; gap: var(--space-2); }
    .edit-bar-actions { display: flex; gap: var(--space-2); }
    .btn-reset { background: transparent; border: 1px solid var(--edit-accent); color: var(--edit-accent); padding: 5px var(--space-3); border-radius: var(--radius-sm); cursor: pointer; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); }
    .btn-reset:hover { background: var(--edit-tint-10); }
    .btn-done { background: var(--edit-accent); color: var(--color-white); padding: 5px var(--space-4); border-radius: var(--radius-sm); cursor: pointer; font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); border: none; }
    .btn-reset:focus-visible, .btn-done:focus-visible { outline: 2px solid var(--edit-accent); outline-offset: 2px; }

    /* ── Error banner ── */
    .error-banner { background: var(--danger-light); border: 1px solid var(--color-red-300); border-radius: var(--radius); padding: var(--space-2) var(--space-4); font-size: var(--font-size-md); color: var(--danger); margin: 0 var(--space-6) var(--space-4); display: none; align-items: center; gap: var(--space-2); }
    .error-banner.visible { display: flex; }

    /* ── Dashboard main ── */
    .dashboard-main { padding: var(--space-5) var(--space-6) var(--space-8); max-width: 1400px; margin: 0 auto; }

    /* ── Tile grid ── */
    .tile-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
    @media (max-width: 768px)  { .tile-grid { grid-template-columns: 1fr; } }
    @media (min-width: 1280px) { .tile-grid { gap: var(--space-4); } }

    /* ── Tile ── */
    .tile { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow-sm); overflow: hidden; position: relative; transition: box-shadow var(--transition-normal); }
    .tile.wide { grid-column: span 2; }
    @media (max-width: 768px) { .tile.wide { grid-column: span 1; } }

    /* Edit mode tile styles */
    body.edit-mode .tile { box-shadow: 0 0 0 2px var(--edit-accent), var(--shadow-sm); cursor: default; }
    body.edit-mode .tile:hover { box-shadow: 0 0 0 2px var(--edit-accent), var(--shadow-md); }
    body.edit-mode .tile.sortable-ghost { opacity: .4; }
    body.edit-mode .tile.sortable-chosen { box-shadow: var(--shadow-lg); }

    .tile-header { padding: var(--space-4); display: flex; align-items: center; justify-content: space-between; gap: var(--space-2); min-height: 44px; border-bottom: 1px solid var(--border); }
    .tile-title { font-size: var(--font-size-md); font-weight: var(--font-weight-bold); text-transform: uppercase; letter-spacing: var(--letter-spacing-label); display: flex; align-items: center; gap: 7px; flex: 1; color: var(--text); }
    .tile-title svg { flex-shrink: 0; }
    .tile-body { padding: var(--space-3) var(--space-4) var(--space-4); }

    /* Tile edit controls */
    .tile-controls { display: none; align-items: center; gap: var(--space-1); }
    body.edit-mode .tile-controls { display: flex; }
    .drag-handle { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: grab; color: var(--edit-accent); border-radius: var(--radius-sm); font-size: var(--font-size-lg); line-height: 1; }
    .drag-handle:active { cursor: grabbing; }
    .drag-handle:focus-visible { outline: 2px solid var(--edit-accent); outline-offset: 2px; }
    .tile-ctrl-btn { width: 26px; height: 26px; border: none; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: var(--font-size-md); transition: background var(--transition-fast); }
    .tile-ctrl-btn:focus-visible { outline: 2px solid var(--edit-accent); outline-offset: 1px; }
    .resize-btn { background: var(--edit-tint-10); color: var(--edit-accent); }
    .resize-btn:hover { background: var(--edit-tint-20); }
    .remove-btn { background: var(--danger-light); color: var(--danger); }
    .remove-btn:hover { background: var(--color-red-100); }

    /* ── Add tile button ── */
    .add-tile-btn { grid-column: span 2; border: 2px dashed var(--edit-accent); border-radius: var(--radius); background: var(--edit-tint-04); color: var(--edit-accent); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); padding: var(--space-5); cursor: pointer; display: none; align-items: center; justify-content: center; gap: var(--space-2); transition: background var(--transition-fast); }
    .add-tile-btn:hover { background: var(--edit-tint-10); }
    .add-tile-btn:focus-visible { outline: 2px solid var(--edit-accent); outline-offset: 2px; }
    body.edit-mode .add-tile-btn { display: flex; }

    /* ── Add tile drawer ── */
    .drawer-overlay { position: fixed; inset: 0; background: var(--overlay-backdrop); z-index: var(--z-overlay); display: none; }
    .drawer-overlay.visible { display: block; }
    .drawer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); border-radius: var(--radius-lg) var(--radius-lg) 0 0; box-shadow: var(--shadow-drawer); z-index: var(--z-drawer); max-height: 70vh; display: flex; flex-direction: column; transform: translateY(100%); transition: transform var(--transition-drawer); }
    .drawer.open { transform: translateY(0); }
    .drawer-header { padding: var(--space-5) var(--space-6) var(--space-4); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .drawer-title { font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); }
    .drawer-close { width: 32px; height: 32px; border: none; background: var(--bg); border-radius: var(--radius-full); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
    .drawer-close:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
    .drawer-body { overflow-y: auto; padding: var(--space-4) var(--space-6) var(--space-8); }
    .tile-palette { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: var(--space-3); }
    .palette-item { border: 1px solid var(--border); border-radius: var(--radius); padding: 14px var(--space-4); cursor: pointer; transition: all var(--transition-fast); display: flex; flex-direction: column; gap: var(--space-1); }
    .palette-item:hover { border-color: var(--primary); background: var(--primary-light); }
    .palette-item.already-added { opacity: .45; cursor: not-allowed; pointer-events: none; }
    .palette-item-name { font-size: var(--font-size-md); font-weight: var(--font-weight-bold); display: flex; align-items: center; gap: 7px; }
    .palette-item-desc { font-size: var(--font-size-sm); color: var(--text-secondary); line-height: 1.4; }
    .palette-item-size { font-size: var(--font-size-xs); color: var(--primary); font-weight: var(--font-weight-semibold); }

    /* ── Stat cards ── */
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-2); }
    @media (max-width: 900px) { .stat-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .stat-grid { grid-template-columns: repeat(2, 1fr); } }
    /* White card surface — no tinted background per reference */
    .stat-card { border-radius: var(--radius); padding: var(--space-3); position: relative; overflow: hidden; background: var(--card); border: 1px solid var(--border); }
    .stat-icon { width: 30px; height: 30px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-2); }
    .stat-card.primary .stat-icon { background: var(--icon-tint-primary); color: var(--primary); }
    .stat-card.success .stat-icon { background: var(--icon-tint-success); color: var(--success); }
    .stat-card.moving  .stat-icon { background: var(--icon-tint-moving);  color: var(--moving); }
    .stat-card.neutral .stat-icon { background: var(--icon-tint-neutral); color: var(--neutral); }
    .stat-card.warning .stat-icon { background: var(--icon-tint-warning); color: var(--warning); }
    .stat-card.danger  .stat-icon { background: var(--icon-tint-danger);  color: var(--danger); }
    /* Value number is colored, not the card background */
    .stat-value { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); line-height: var(--line-height-tight); margin-bottom: var(--space-1); }
    .stat-card.primary .stat-value { color: var(--primary); }
    .stat-card.success .stat-value { color: var(--success); }
    .stat-card.moving  .stat-value { color: var(--moving); }
    .stat-card.neutral .stat-value { color: var(--neutral); }
    .stat-card.warning .stat-value { color: var(--warning); }
    .stat-card.danger  .stat-value { color: var(--danger); }
    .stat-label { font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); color: var(--text-secondary); text-transform: uppercase; letter-spacing: var(--letter-spacing-label); }

    /* ── Row list (task/fleet/maintenance cards) ── */
    .row-list { display: flex; flex-direction: column; gap: 1px; }
    .row-item { display: flex; align-items: center; justify-content: space-between; padding: 7px 0; border-bottom: 1px solid var(--bg); }
    .row-item:last-child { border-bottom: none; }
    .row-label { display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-size-md); color: var(--text-secondary); }
    .dot { width: 8px; height: 8px; border-radius: var(--radius-full); flex-shrink: 0; }
    .dot-primary { background: var(--primary); }
    .dot-success { background: var(--success); }
    .dot-moving  { background: var(--moving); }
    .dot-warning { background: var(--color-amber-400); }
    .dot-danger  { background: var(--danger); }
    .dot-neutral { background: var(--neutral); }
    .row-value { font-size: 15px; font-weight: var(--font-weight-bold); }
    .row-value.danger  { color: var(--danger); }
    .row-value.warning { color: var(--warning); }
    .row-value.success { color: var(--success); }

    /* ── Sub section header ── */
    .sub-head { font-size: var(--font-size-xs); font-weight: var(--font-weight-bold); text-transform: uppercase; letter-spacing: var(--letter-spacing-wide); color: var(--text-secondary); margin: var(--space-3) 0 var(--space-1); }

    /* ── Chart container ── */
    .chart-wrap { position: relative; }
    .chart-meta { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3); }
    .chart-big-num { font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--primary); }
    .chart-sub { font-size: var(--font-size-sm); color: var(--text-secondary); }

    /* ── Events table ── */
    .table-wrap { overflow-x: auto; margin: 0 calc(-1 * var(--space-4)); padding: 0 var(--space-4); }
    table { width: 100%; border-collapse: collapse; font-size: var(--font-size-md); min-width: 520px; }
    th { text-align: left; padding: var(--space-2) var(--space-3); font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); text-transform: uppercase; letter-spacing: var(--letter-spacing-label); color: var(--text-secondary); background: var(--bg); border-bottom: 1px solid var(--border); }
    td { padding: 9px var(--space-3); border-bottom: 1px solid var(--bg); color: var(--text); white-space: nowrap; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--color-gray-50); }
    .evt-badge { display: inline-flex; align-items: center; gap: var(--space-1); padding: 2px 7px; border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); }
    .evt-offline { background: var(--danger-light);  color: var(--danger); }
    .evt-online  { background: var(--success-light); color: var(--success); }
    .evt-alarm   { background: var(--warning-light); color: var(--warning); }
    .evt-default { background: var(--neutral-light); color: var(--neutral); }

    /* ── Skeleton shimmer loader ── */
    @keyframes shimmer {
      0%   { background-position: -400px 0; }
      100% { background-position:  400px 0; }
    }
    .skel {
      display: inline-block; border-radius: var(--radius-sm);
      background: linear-gradient(90deg, var(--skeleton-base) 25%, var(--skeleton-highlight) 50%, var(--skeleton-base) 75%);
      background-size: 800px 100%;
      animation: shimmer var(--skeleton-speed) linear infinite;
    }
    .skel-line     { height: 12px; width: 100%; margin-bottom: var(--space-2); display: block; }
    .skel-line--sm { width: 60%; }
    .skel-line--md { width: 80%; }
    .skel-value    { height: 32px; width: 50%; display: block; margin-bottom: var(--space-1); }
    .skel-row      { display: flex; gap: var(--space-3); align-items: center; padding: 7px 0; }
    .skel-dot      { width: 8px; height: 8px; border-radius: var(--radius-full); flex-shrink: 0; }
    .skel-chart    { width: 100%; border-radius: var(--radius-sm); display: block; }

    /* ── Tile error component ── */
    .tile-error { display: flex; flex-direction: column; align-items: center; padding: var(--space-8) var(--space-4); text-align: center; gap: var(--space-2); }
    .tile-error__icon  { width: 36px; height: 36px; border-radius: var(--radius-full); background: var(--danger-light); color: var(--danger); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-1); }
    .tile-error__title { font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); color: var(--danger); }
    .tile-error__msg   { font-size: var(--font-size-sm); color: var(--text-secondary); max-width: 240px; line-height: var(--line-height-normal); }
    .tile-error__retry { margin-top: var(--space-1); font-size: var(--font-size-sm); padding: 5px var(--space-3); border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--card); cursor: pointer; color: var(--text); transition: background var(--transition-fast); }
    .tile-error__retry:hover { background: var(--bg); }
    .tile-error__retry:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }

    /* ── Tile empty state component ── */
    .tile-empty { display: flex; flex-direction: column; align-items: center; padding: var(--space-8) var(--space-4); text-align: center; gap: var(--space-2); }
    .tile-empty__icon  { width: 40px; height: 40px; border-radius: var(--radius-full); background: var(--neutral-light); color: var(--neutral); display: flex; align-items: center; justify-content: center; margin-bottom: var(--space-1); }
    .tile-empty__title { font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); color: var(--text); }
    .tile-empty__desc  { font-size: var(--font-size-sm); color: var(--text-secondary); max-width: 240px; line-height: var(--line-height-normal); }

    /* ── Legacy empty (kept as fallback) ── */
    .empty { text-align: center; padding: var(--space-8) var(--space-4); color: var(--text-secondary); font-size: var(--font-size-md); }

    /* ── Badges ── */
    .badge         { display: inline-block; padding: 2px var(--space-2); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); }
    .badge-danger  { background: var(--danger-light);  color: var(--danger); }
    .badge-warning { background: var(--warning-light); color: var(--warning); }

    /* ── History trend note ── */
    .trend-note { font-size: var(--font-size-xs); color: var(--text-secondary); margin-top: var(--space-1); text-align: center; font-style: italic; }

    /* ── Footer ── */
    .footer { text-align: center; padding: var(--space-4); font-size: var(--font-size-sm); color: var(--text-secondary); }

    /* ── Setup debug panel ── */
    #debugPanel { max-width: 560px; width: 100%; margin-top: var(--space-4); }
  </style>
</head>
<body>

<!-- ══ Header ══ -->
<header class="header">
  <div class="header-left">
    <div class="header-logo">NX</div>
    <span class="header-title">Account Overview</span>
  </div>
  <div class="header-right">
    <div class="user-badge">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/></svg>
      <span id="userEmail">—</span>
    </div>
    <span class="server-badge" id="serverBadge"></span>
    <span class="header-meta" id="lastRefreshLabel">—</span>
    <button class="btn btn-edit" id="editBtn" onclick="toggleEditMode()" aria-label="Customize dashboard layout" aria-pressed="false">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
      Customize
    </button>
    <button class="btn btn-ghost" id="refreshBtn" onclick="refresh()" aria-label="Refresh dashboard data">
      <svg id="refreshIcon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M17.65 6.35A7.96 7.96 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
      Refresh
    </button>
  </div>
</header>

<!-- ══ Edit mode bar ══ -->
<div class="edit-bar" id="editBar">
  <div class="edit-bar-info">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
    Drag tiles to reorder · click ↔ to toggle width · × to remove
  </div>
  <div class="edit-bar-actions">
    <button class="btn-reset" onclick="resetLayout()">Reset to default</button>
    <button class="btn-done" onclick="toggleEditMode()">Done</button>
  </div>
</div>

<!-- ══ Setup screen ══ -->
<div class="setup-screen" id="setupScreen">
  <div class="setup-icon">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
  </div>
  <h2 class="setup-title">Authentication Required</h2>
  <p class="setup-desc">Configure this as a <strong>User Application</strong> in Navixy with <strong>Session key</strong> GET parameter enabled, or open directly with <code>?session_key=YOUR_KEY</code>.</p>
  <div class="setup-box">
    <h3>Setup as Navixy User Application</h3>
    <div class="setup-step"><div class="setup-num">1</div><div>Go to <strong>Account Settings → User Applications</strong> in Navixy.</div></div>
    <div class="setup-step"><div class="setup-num">2</div><div>Create app: <strong>Display as: Embedded</strong>, <strong>GET parameters: Session key ✓</strong></div></div>
    <div class="setup-step"><div class="setup-num">3</div><div>Or open directly: <code class="setup-code">index.html?session_key=YOUR_KEY&amp;server=https://api.eu.navixy.com</code></div></div>
  </div>
  <div id="debugPanel"></div>
</div>

<!-- ══ Dashboard ══ -->
<div id="dashboardRoot" style="display:none">
  <div class="error-banner" id="errorBanner">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    <span id="errorMsg"></span>
  </div>
  <div class="dashboard-main">
    <div class="tile-grid" id="tileGrid"></div>
    <button class="add-tile-btn" id="addTileBtn" onclick="openDrawer()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
      Add Tile
    </button>
  </div>
  <div class="footer">Navixy Account Dashboard · Auto-refreshes every 60 s · Layout saved in browser</div>
</div>

<!-- ══ Add-tile drawer ══ -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="drawer-title">Add a Tile</div>
    <button class="drawer-close" onclick="closeDrawer()" aria-label="Close tile picker">×</button>
  </div>
  <div class="drawer-body">
    <div class="tile-palette" id="tilePalette"></div>
  </div>
</div>

<script>
// ════════════════════════════════════════════════
// CONFIG
// ════════════════════════════════════════════════
const params  = new URLSearchParams(window.location.search);
const HASH    = params.get('session_key') || params.get('hash') || params.get('session_hash') || params.get('key') || params.get('token') || '';
let   SERVER  = (params.get('server') || '').replace(/\/$/, '');  // resolved by detectServer()
let   BASE    = '';
const HISTORY_KEY  = 'nvx_conn_history_' + HASH.slice(0, 8);
const LAYOUT_KEY   = 'nvx_layout_v2';
const MAX_HISTORY  = 120; // data points

// ════════════════════════════════════════════════
// STATE
// ════════════════════════════════════════════════
let cache    = {};          // shared data cache
let layout   = [];          // [ { tileId, size } ]  size: 'normal' | 'wide'
let editMode = false;
let sortable = null;
let charts   = {};          // { tileId: Chart }
let isLoading = false;
let connHistory = [];       // [ { t, online, offline, idle, moving } ]
let lastRefreshTime = 0;    // ms timestamp of last completed refresh

// ════════════════════════════════════════════════
// TILE REGISTRY
// ════════════════════════════════════════════════
const TILE_DEFS = {
  'tracker-stats': {
    label: 'Tracker Status',
    desc:  'Online, offline, moving, parked, idle counts',
    icon:  iconPath('M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'),
    defaultSize: 'wide',
    needs: ['states'],
    render: renderTrackerStats
  },
  'tracker-pie': {
    label: 'Status Distribution',
    desc:  'Pie chart of online / idle / offline',
    icon:  iconPath('M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z'),
    defaultSize: 'normal',
    needs: ['states'],
    render: renderTrackerPie
  },
  'connection-trend': {
    label: 'Connection Trend',
    desc:  'Online / offline count over time (session history)',
    icon:  iconPath('M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z'),
    defaultSize: 'wide',
    needs: [],   // uses connHistory
    render: renderConnectionTrend
  },
  'tasks-today': {
    label: "Today's Tasks",
    desc:  'Task counts by status for today',
    icon:  iconPath('M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z'),
    defaultSize: 'normal',
    needs: ['tasks'],
    render: renderTasksToday
  },
  'tasks-pie': {
    label: 'Task Distribution',
    desc:  'Pie chart of task statuses',
    icon:  iconPath('M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z'),
    defaultSize: 'normal',
    needs: ['tasks'],
    render: renderTasksPie
  },
  'fleet-overview': {
    label: 'Fleet Overview',
    desc:  'Vehicle counts, tracker linkage, fuel types',
    icon:  iconPath('M18.92 5.01C18.72 4.42 18.16 4 17.5 4h-11c-.66 0-1.21.42-1.42 1.01L3 11v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 15c-.83 0-1.5-.67-1.5-1.5S5.67 12 6.5 12s1.5.67 1.5 1.5S7.33 15 6.5 15zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 10l1.5-4.5h11L19 10H5z'),
    defaultSize: 'normal',
    needs: ['vehicles'],
    render: renderFleetOverview
  },
  'maintenance': {
    label: 'Maintenance',
    desc:  'Service tasks: expired, due soon, scheduled',
    icon:  iconPath('M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z'),
    defaultSize: 'normal',
    needs: ['serviceTasks'],
    render: renderMaintenance
  },
  'mileage-bar': {
    label: 'Mileage – Bar Chart',
    desc:  '7-day fleet mileage as a bar chart',
    icon:  iconPath('M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 8H19v6h-2.8v-6z'),
    defaultSize: 'wide',
    needs: ['mileage'],
    render: renderMileageBar
  },
  'mileage-line': {
    label: 'Mileage – Line Chart',
    desc:  '7-day fleet mileage as a trend line',
    icon:  iconPath('M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z'),
    defaultSize: 'wide',
    needs: ['mileage'],
    render: renderMileageLine
  },
  'top-objects': {
    label: 'Top Objects by Mileage',
    desc:  'Top 10 objects ranked by 7-day mileage',
    icon:  iconPath('M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z'),
    defaultSize: 'normal',
    needs: ['mileage'],
    render: renderTopObjects
  },
  'events-table': {
    label: 'Recent Events',
    desc:  'Last 30 tracker events from the past 24 h',
    icon:  iconPath('M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z'),
    defaultSize: 'wide',
    needs: ['events'],
    render: renderEventsTable
  }
};

const DEFAULT_LAYOUT = [
  { tileId: 'tracker-stats',    size: 'wide'   },
  { tileId: 'tasks-today',      size: 'normal' },
  { tileId: 'fleet-overview',   size: 'normal' },
  { tileId: 'maintenance',      size: 'normal' },
  { tileId: 'tracker-pie',      size: 'normal' },
  { tileId: 'mileage-bar',      size: 'wide'   },
  { tileId: 'top-objects',      size: 'normal' },
  { tileId: 'connection-trend', size: 'wide'   },
  { tileId: 'events-table',     size: 'wide'   },
];

function iconPath(d) {
  return `<svg width="15" height="15" viewBox="0 0 24 24" fill="var(--primary)"><path d="${d}"/></svg>`;
}

// ════════════════════════════════════════════════
// SKELETON HELPERS
// ════════════════════════════════════════════════
function skeletonForTile(tileId) {
  if (tileId === 'tracker-stats')
    return `<div class="stat-grid">${Array(6).fill(0).map(() => `
      <div class="stat-card neutral">
        <span class="skel" style="width:30px;height:30px;border-radius:var(--radius-sm);display:block"></span>
        <span class="skel skel-value"></span>
        <span class="skel skel-line skel-line--sm"></span>
      </div>`).join('')}</div>`;

  if (['tracker-pie', 'tasks-pie'].includes(tileId))
    return `<div style="display:flex;flex-direction:column;align-items:center;gap:var(--space-2);padding:var(--space-4) 0">
      <span class="skel" style="width:160px;height:160px;border-radius:50%;display:block"></span>
      <span class="skel skel-line skel-line--md" style="margin-top:var(--space-2)"></span></div>`;

  if (['mileage-bar', 'mileage-line', 'connection-trend', 'top-objects'].includes(tileId))
    return `<span class="skel skel-line skel-line--sm" style="height:16px;width:120px;margin-bottom:var(--space-3)"></span>
            <span class="skel skel-chart" style="height:200px"></span>`;

  if (tileId === 'events-table')
    return Array(5).fill(0).map((_, i) => `
      <div class="skel-row">
        <span class="skel skel-line" style="width:${60 + i * 10}px;height:10px;margin:0"></span>
        <span class="skel skel-line" style="width:80px;height:10px;margin:0"></span>
        <span class="skel skel-line" style="width:50px;height:10px;margin:0"></span>
      </div>`).join('');

  // Generic row list (tasks-today, fleet-overview, maintenance)
  return Array(4).fill(0).map(() => `
    <div class="skel-row">
      <span class="skel skel-dot"></span>
      <span class="skel skel-line" style="flex:1;height:10px;margin:0"></span>
      <span class="skel skel-line" style="width:28px;height:10px;margin:0"></span>
    </div>`).join('');
}

function showSkeletons() {
  layout.forEach(item => {
    const body = document.getElementById(`body_${item.tileId}`);
    if (body) body.innerHTML = skeletonForTile(item.tileId);
  });
}

// ════════════════════════════════════════════════
// LAYOUT PERSISTENCE
// ════════════════════════════════════════════════
function loadLayout() {
  try { return JSON.parse(localStorage.getItem(LAYOUT_KEY)) || null; } catch { return null; }
}
function saveLayout() {
  localStorage.setItem(LAYOUT_KEY, JSON.stringify(layout));
}
function resetLayout() {
  layout = DEFAULT_LAYOUT.map(t => ({ ...t }));
  saveLayout();
  renderLayout();
}

function loadConnHistory() {
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch { return []; }
}
function saveConnHistory() {
  localStorage.setItem(HISTORY_KEY, JSON.stringify(connHistory));
}

// ════════════════════════════════════════════════
// API HELPER
// ════════════════════════════════════════════════
async function api(endpoint, body = {}) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000);
  try {
    const r = await fetch(`${BASE}${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ hash: HASH, ...body }),
      signal: controller.signal
    });
    if (!r.ok) {
      // Try to extract Navixy's error description from the body before giving up
      try { const e = await r.json(); throw new Error(e.status?.description || e.status?.code || `HTTP ${r.status}`); }
      catch(e) { throw (e.message.startsWith('HTTP') ? e : e); }
    }
    const d = await r.json();
    if (!d.success) throw new Error(d.status?.description || d.status?.code || 'API error');
    return d;
  } catch(e) {
    throw controller.signal.aborted ? new Error('Request timed out') : e;
  } finally {
    clearTimeout(timeoutId);
  }
}

// ════════════════════════════════════════════════
// DATE HELPERS
// ════════════════════════════════════════════════
const pad = n => String(n).padStart(2, '0');
function fmtDT(d) {
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function todayStart() { const d = new Date(); d.setHours(0,0,0,0); return fmtDT(d); }
function todayEnd()   { const d = new Date(); d.setHours(23,59,59,0); return fmtDT(d); }
function daysAgo(n)   { const d = new Date(); d.setDate(d.getDate()-n); d.setHours(0,0,0,0); return fmtDT(d); }
function shortDate(iso) {
  try { return new Date(iso+'T00:00:00').toLocaleDateString(undefined,{month:'short',day:'numeric'}); } catch { return iso; }
}
function fmtTime(ts) {
  try { return new Date(ts).toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'}); } catch { return '—'; }
}
function fmtDateTime(str) {
  try { return new Date(str.replace(' ','T')).toLocaleString(undefined,{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}); } catch { return str; }
}

// ════════════════════════════════════════════════
// DATA FETCHING
// ════════════════════════════════════════════════
async function fetchAll() {
  cache.errors = {};

  // Parallel: trackers+states, tasks, vehicles, service tasks
  const [trkRes, taskRes, vehRes, svcRes] = await Promise.allSettled([
    fetchTrackers(),
    fetchTasks(),
    fetchVehicles(),
    fetchServiceTasks()
  ]);

  // Store errors keyed by the cache/needs name so tiles can surface them
  if (trkRes.status  === 'rejected') cache.errors.states       = trkRes.reason?.message  || 'Request failed';
  if (taskRes.status === 'rejected') cache.errors.tasks        = taskRes.reason?.message || 'Request failed';
  if (vehRes.status  === 'rejected') cache.errors.vehicles     = vehRes.reason?.message  || 'Request failed';
  if (svcRes.status  === 'rejected') cache.errors.serviceTasks = svcRes.reason?.message  || 'Request failed';

  // Mileage needs tracker IDs
  const ids = cache.trackerIds || [];
  if (ids.length > 0) {
    try { await fetchMileage(ids); }
    catch(e) { cache.errors.mileage = e.message || 'Request failed'; cache.mileage = null; }
  } else {
    cache.mileage = null;
  }

  // Events needs tracker IDs (first 100)
  try { await fetchEvents(ids.slice(0, 100)); }
  catch(e) { cache.errors.events = e.message || 'Request failed'; cache.events = []; }

  // Update connection history
  appendConnHistory();
}

async function fetchTrackers() {
  const listData = await api('/tracker/list');
  const trackers = listData.list || [];
  cache.trackers = trackers;
  const ids = trackers.map(t => t.id);
  cache.trackerIds = ids;

  if (ids.length === 0) {
    cache.states = {};
    cache.statusCounts = { online:0, moving:0, parked:0, idle:0, offline:0 };
    return;
  }

  // Batch get_states
  const allStates = {};
  const BATCH = 100;
  for (let i = 0; i < ids.length; i += BATCH) {
    const batch = ids.slice(i, i+BATCH);
    try {
      const sd = await api('/tracker/get_states', { trackers: batch });
      Object.assign(allStates, sd.states || {});
    } catch(e) { console.warn('get_states:', e); }
  }
  cache.states = allStates;

  let online=0, moving=0, parked=0, idle=0, offline=0;
  Object.values(allStates).forEach(s => {
    if (s.connection_status === 'active')   online++;
    else if (s.connection_status === 'idle') idle++;
    else                                    offline++;
    if (s.movement_status === 'moving') moving++;
    else                                parked++;
  });
  offline += ids.length - Object.keys(allStates).length;

  cache.statusCounts = { online, moving, parked, idle, offline };
}

async function fetchTasks() {
  const d = await api('/task/list', { from: todayStart(), to: todayEnd(), limit: 10000 });
  cache.tasks = d.list || [];
  const c = { assigned:0, arrived:0, done:0, failed:0, delayed:0, unassigned:0, faulty:0 };
  cache.tasks.forEach(t => { if (c[t.status]!==undefined) c[t.status]++; });
  cache.taskCounts = c;
}

async function fetchVehicles() {
  const d = await api('/vehicle/list', { limit: 10000 });
  cache.vehicles = d.list || [];
}

async function fetchServiceTasks() {
  const d = await api('/vehicle/service_task/list');
  const tasks = d.list || [];
  cache.serviceTasks = tasks;
  cache.svcCounts = { expired:0, notified:0, created:0, done:0 };
  tasks.forEach(t => { if (cache.svcCounts[t.status]!==undefined) cache.svcCounts[t.status]++; });
}

async function fetchMileage(ids) {
  const d = await api('/tracker/stats/mileage/read', {
    trackers: ids, from: daysAgo(6), to: fmtDT(new Date())
  });
  if (d.limit_exceeded) {
    // Partial data — flag a warning but keep what we got
    cache.errors = cache.errors || {};
    cache.errors.mileage = 'Results are partial: fleet size exceeds mileage report limit.';
  }
  cache.mileageResult = d.result || {};

  // Build 7-day array
  const days = [];
  for (let i=6; i>=0; i--) {
    const dd = new Date(); dd.setDate(dd.getDate()-i);
    days.push(dd.toISOString().slice(0,10));
  }
  const daily = {};
  days.forEach(d => { daily[d] = 0; });

  const perTracker = {};
  Object.entries(cache.mileageResult).forEach(([tid, dayMap]) => {
    let tot = 0;
    Object.entries(dayMap).forEach(([date, val]) => {
      const km = (typeof val === 'object' && val !== null) ? (val.mileage||0) : (val||0);
      if (daily[date]!==undefined) daily[date] += km;
      tot += km;
    });
    if (tot > 0) perTracker[tid] = tot;
  });

  cache.mileage = {
    days,
    totals: days.map(d => Math.round((daily[d]||0)*10)/10),
    grandTotal: days.reduce((s,d)=>s+(daily[d]||0), 0),
    perTracker
  };
}

async function fetchEvents(ids) {
  if (!ids.length) { cache.events = []; cache.eventTotal = 0; return; }
  const d = await api('/history/tracker/list', {
    trackers: ids, from: daysAgo(1), to: fmtDT(new Date()),
    limit: 30, ascending: false
  });
  cache.events = d.list || [];
  cache.eventTotal = d.total || cache.events.length;
}

function appendConnHistory() {
  const c = cache.statusCounts;
  if (!c) return;
  connHistory.push({ t: Date.now(), online: c.online, offline: c.offline, idle: c.idle, moving: c.moving });
  if (connHistory.length > MAX_HISTORY) connHistory = connHistory.slice(-MAX_HISTORY);
  saveConnHistory();
}

// ════════════════════════════════════════════════
// TILE RENDERERS
// ════════════════════════════════════════════════

function renderTrackerStats(body) {
  const sc = cache.statusCounts || {};
  const total = (cache.trackers||[]).length;
  body.innerHTML = `<div class="stat-grid">
    ${sCard('primary', total,         'Total Objects', 'M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z')}
    ${sCard('success', sc.online??'—', 'Online',        'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z')}
    ${sCard('moving',  sc.moving??'—', 'Moving',        'M18.92 5.01C18.72 4.42 18.16 4 17.5 4h-11c-.66 0-1.21.42-1.42 1.01L3 11v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 15c-.83 0-1.5-.67-1.5-1.5S5.67 12 6.5 12s1.5.67 1.5 1.5S7.33 15 6.5 15zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 10l1.5-4.5h11L19 10H5z')}
    ${sCard('neutral', sc.parked??'—', 'Parked',        'M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z')}
    ${sCard('warning', sc.idle??'—',   'Idle/No GPS',   'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z')}
    ${sCard('danger',  sc.offline??'—','Offline',       'M20 18.54L5.46 4 4 5.46l3 3L5 11v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-6.54l1.54 1.54L20 18.54z')}
  </div>`;
}

function sCard(type, val, label, path) {
  return `<div class="stat-card ${type}">
    <div class="stat-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="${path}"/></svg></div>
    <div class="stat-value">${val}</div>
    <div class="stat-label">${label}</div>
  </div>`;
}

function renderTrackerPie(body, tileId) {
  const sc = cache.statusCounts || {};
  // online/idle/offline are mutually exclusive (connection_status); moving overlaps with
  // online so must not be a separate pie segment — it is already shown in the stat cards.
  const vals = [sc.online||0, sc.idle||0, sc.offline||0];
  if (vals.every(v=>v===0)) {
    body.innerHTML = `<div class="tile-empty">
      <div class="tile-empty__icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z"/></svg></div>
      <div class="tile-empty__title">No tracker data</div>
      <div class="tile-empty__desc">Status will appear after the first refresh.</div>
    </div>`;
    return;
  }
  body.innerHTML = `<div class="chart-wrap" style="height:200px"><canvas id="c_${tileId}"></canvas></div>`;
  newChart(tileId, `c_${tileId}`, 'doughnut', {
    labels: ['Online (active)', 'Idle / No GPS', 'Offline'],
    datasets: [{ data: vals, backgroundColor: ['#2e7d32','#e65100','#c62828'], borderWidth: 0, hoverOffset: 4 }]
  }, {
    plugins: { legend: { position:'bottom', labels: { font:{size:11}, padding:10 } }, tooltip: { callbacks: { label: c => ` ${c.label}: ${c.parsed}` } } },
    cutout: '65%'
  });
}

function renderConnectionTrend(body, tileId) {
  if (connHistory.length < 2) {
    body.innerHTML = `<div class="tile-empty">
      <div class="tile-empty__icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg></div>
      <div class="tile-empty__title">Building history</div>
      <div class="tile-empty__desc">Updates every 60 s — come back in a few minutes.</div>
    </div>`;
    return;
  }
  const labels = connHistory.map(h => fmtTime(h.t));
  body.innerHTML = `<div class="chart-wrap" style="height:200px"><canvas id="c_${tileId}"></canvas></div>
    <p class="trend-note">${connHistory.length} data point${connHistory.length!==1?'s':''} · updates every 60 s</p>`;
  newChart(tileId, `c_${tileId}`, 'line', {
    labels,
    datasets: [
      lineDS('Online',    connHistory.map(h=>h.online),  '#2e7d32', '#e8f5e9'),
      lineDS('Moving',    connHistory.map(h=>h.moving),  '#00796b', '#e0f2f1'),
      lineDS('Idle',      connHistory.map(h=>h.idle),    '#f9a825', '#fffde7'),
      lineDS('Offline',   connHistory.map(h=>h.offline), '#c62828', '#ffebee'),
    ]
  }, {
    plugins: { legend: { position:'bottom', labels:{ font:{size:11}, padding:10, boxWidth:10 } }, tooltip:{ mode:'index', intersect:false } },
    scales: {
      x: { grid:{display:false}, ticks:{ maxTicksLimit:8, font:{size:11} } },
      y: { beginAtZero:true, grid:{ color:'rgba(0,0,0,0.04)' }, ticks:{ font:{size:11} } }
    },
    interaction: { mode:'index', intersect:false }
  });
}

function lineDS(label, data, color, fill) {
  return { label, data, borderColor: color, backgroundColor: fill, borderWidth: 2, pointRadius: 0, tension: 0.3, fill: false };
}

function renderTasksToday(body) {
  const c = cache.taskCounts || {};
  const total = (cache.tasks||[]).length;
  body.innerHTML = `<div class="row-list">
    ${rRow('dot-primary','Total',      total,             '')}
    ${rRow('dot-primary','Assigned',   c.assigned||0,     '')}
    ${rRow('dot-warning','In progress',c.arrived||0,      '')}
    ${rRow('dot-success','Done',       c.done||0,         'success')}
    ${rRow('dot-danger', 'Failed',     c.failed||0,       'danger')}
    ${rRow('dot-warning','Delayed',    c.delayed||0,      'warning')}
    ${rRow('dot-neutral','Unassigned', (c.unassigned||0)+(c.faulty||0), '')}
  </div>`;
}

function renderTasksPie(body, tileId) {
  const c = cache.taskCounts || {};
  const vals = [c.assigned||0, c.arrived||0, c.done||0, c.failed||0, c.delayed||0, c.unassigned||0];
  if (vals.every(v=>v===0)) {
    body.innerHTML = `<div class="tile-empty">
      <div class="tile-empty__icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div>
      <div class="tile-empty__title">No tasks today</div>
      <div class="tile-empty__desc">No tasks scheduled or assigned for today.</div>
    </div>`;
    return;
  }
  body.innerHTML = `<div class="chart-wrap" style="height:200px"><canvas id="c_${tileId}"></canvas></div>`;
  newChart(tileId, `c_${tileId}`, 'doughnut', {
    labels: ['Assigned','In progress','Done','Failed','Delayed','Unassigned'],
    datasets: [{ data: vals, backgroundColor: ['#1565c0','#e65100','#2e7d32','#c62828','#f9a825','#546e7a'], borderWidth:0, hoverOffset:4 }]
  }, {
    plugins: { legend:{ position:'bottom', labels:{font:{size:11},padding:8} }, tooltip:{callbacks:{label:c=>` ${c.label}: ${c.parsed}`}} },
    cutout: '65%'
  });
}

function renderFleetOverview(body) {
  const v = cache.vehicles || [];
  const linked   = v.filter(x=>x.tracker_id).length;
  const unlinked = v.length - linked;

  const fuelMap = {};
  v.forEach(x => { const f = x.fuel_type||'unknown'; fuelMap[f]=(fuelMap[f]||0)+1; });
  const fuelRows = Object.entries(fuelMap).sort((a,b)=>b[1]-a[1]).map(([t,n]) =>
    rRow('dot-neutral', escHtml(cap(t)), n, '')).join('');

  body.innerHTML = `<div class="row-list">
    ${rRow('dot-primary','Total vehicles', v.length,  '')}
    ${rRow('dot-success','Linked to tracker', linked, '')}
    ${rRow('dot-neutral','Unlinked',       unlinked,  '')}
  </div>
  <div class="sub-head">Fuel types</div>
  <div class="row-list">${fuelRows || '<div class="empty" style="padding:8px 0">No vehicles</div>'}</div>`;
}

function renderMaintenance(body) {
  const sc = cache.svcCounts || {};
  const expired = cache.serviceTasks?.filter(t=>t.status==='expired') || [];
  body.innerHTML = `<div class="row-list">
    ${rRow('dot-danger', 'Expired',   sc.expired||0,  'danger')}
    ${rRow('dot-warning','Due soon',  sc.notified||0, 'warning')}
    ${rRow('dot-primary','Scheduled', sc.created||0,  '')}
    ${rRow('dot-success','Completed', sc.done||0,     'success')}
  </div>
  ${expired.length ? `<div class="sub-head" style="color:var(--danger)">Overdue</div>
    <div class="row-list">${expired.slice(0,4).map(t=>`
      <div class="row-item">
        <div class="row-label" style="overflow:hidden"><span class="dot dot-danger"></span><span style="overflow:hidden;text-overflow:ellipsis">${escHtml(t.vehicle_label||'—')}</span></div>
        <span class="badge badge-danger" style="flex-shrink:0;max-width:120px;overflow:hidden;text-overflow:ellipsis">${escHtml(t.description||'—')}</span>
      </div>`).join('')}
    ${expired.length>4?`<div style="font-size:11px;color:var(--danger);margin-top:4px">+${expired.length-4} more</div>`:''}</div>` : ''}`;
}

function renderMileageBar(body, tileId) {
  const m = cache.mileage;
  if (!m) {
    body.innerHTML = `<div class="tile-empty">
      <div class="tile-empty__icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 8H19v6h-2.8v-6z"/></svg></div>
      <div class="tile-empty__title">No mileage data</div>
      <div class="tile-empty__desc">Mileage appears once trackers report movement.</div>
    </div>`;
    return;
  }
  const total = Math.round(m.grandTotal);
  body.innerHTML = `<div class="chart-meta">
    <div><div class="chart-big-num">${total.toLocaleString()} km</div><div class="chart-sub">Fleet total · last 7 days</div></div>
  </div><div class="chart-wrap" style="height:200px"><canvas id="c_${tileId}"></canvas></div>`;
  newChart(tileId, `c_${tileId}`, 'bar', {
    labels: m.days.map(shortDate),
    datasets: [{ label:'Total km', data: m.totals, backgroundColor:'rgba(21,101,192,.75)', borderColor:'rgba(21,101,192,1)', borderWidth:1, borderRadius:5, borderSkipped:false }]
  }, barOpts());
}

function renderMileageLine(body, tileId) {
  const m = cache.mileage;
  if (!m) {
    body.innerHTML = `<div class="tile-empty">
      <div class="tile-empty__icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg></div>
      <div class="tile-empty__title">No mileage data</div>
      <div class="tile-empty__desc">Mileage appears once trackers report movement.</div>
    </div>`;
    return;
  }
  const total = Math.round(m.grandTotal);
  body.innerHTML = `<div class="chart-meta">
    <div><div class="chart-big-num">${total.toLocaleString()} km</div><div class="chart-sub">Fleet total · last 7 days</div></div>
  </div><div class="chart-wrap" style="height:200px"><canvas id="c_${tileId}"></canvas></div>`;
  newChart(tileId, `c_${tileId}`, 'line', {
    labels: m.days.map(shortDate),
    datasets: [{ label:'Total km', data: m.totals, borderColor:'#1565c0', backgroundColor:'rgba(21,101,192,.1)', borderWidth:2, pointRadius:4, tension:0.3, fill:true }]
  }, lineOpts());
}

function renderTopObjects(body, tileId) {
  const m = cache.mileage;
  if (!m || !Object.keys(m.perTracker).length) {
    body.innerHTML = `<div class="tile-empty">
      <div class="tile-empty__icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div>
      <div class="tile-empty__title">No mileage data</div>
      <div class="tile-empty__desc">Mileage appears once trackers report movement.</div>
    </div>`;
    return;
  }
  const top = Object.entries(m.perTracker).sort((a,b)=>b[1]-a[1]).slice(0,10);
  // Try to match tracker labels
  const trackerMap = {};
  (cache.trackers||[]).forEach(t => { trackerMap[t.id] = t.label||`#${t.id}`; });
  const labels = top.map(([id]) => trackerMap[id] || `#${id}`);
  body.innerHTML = `<div class="chart-wrap" style="height:260px"><canvas id="c_${tileId}"></canvas></div>`;
  const colors = ['#1565c0','#1976d2','#1e88e5','#2196f3','#42a5f5','#64b5f6','#90caf9','#bbdefb','#0d47a1','#0a3880'];
  newChart(tileId, `c_${tileId}`, 'bar', {
    labels,
    datasets: [{ label:'km', data: top.map(([,v])=>Math.round(v*10)/10), backgroundColor: top.map((_,i)=>colors[i%colors.length]), borderRadius:4, borderSkipped:false }]
  }, { ...barOpts(), indexAxis:'y' });
}

function renderEventsTable(body) {
  const evts = cache.events || [];
  if (!evts.length) {
    body.innerHTML = `<div class="tile-empty">
      <div class="tile-empty__icon" aria-hidden="true"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg></div>
      <div class="tile-empty__title">No recent events</div>
      <div class="tile-empty__desc">No tracker events in the last 24 hours.</div>
    </div>`;
    return;
  }
  const rows = evts.map(ev => {
    const loc = ev.location
      ? `<a href="https://www.google.com/maps?q=${ev.location.lat},${ev.location.lng}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none;font-size:11px">${ev.location.lat.toFixed(4)}, ${ev.location.lng.toFixed(4)}</a>`
      : '—';
    return `<tr>
      <td style="color:var(--text-secondary)">${fmtDateTime(ev.time)}</td>
      <td style="font-weight:500">${escHtml(ev.extra?.tracker_label||'#'+ev.tracker_id)}</td>
      <td><span class="evt-badge ${evtCls(ev.event)}">${escHtml(ev.event||'—')}</span></td>
      <td style="color:var(--text-secondary);max-width:220px;overflow:hidden;text-overflow:ellipsis">${escHtml(ev.message||'—')}</td>
      <td>${loc}</td>
    </tr>`;
  }).join('');
  body.innerHTML = `<div style="display:flex;justify-content:flex-end;margin-bottom:8px;font-size:12px;color:var(--text-secondary)">${cache.eventTotal||evts.length} events in last 24 h</div>
  <div class="table-wrap"><table>
    <thead><tr><th>Time</th><th>Object</th><th>Event</th><th>Message</th><th>Location</th></tr></thead>
    <tbody>${rows}</tbody>
  </table></div>`;
}

function evtCls(e) {
  if (!e) return 'evt-default';
  if (e.includes('offline')) return 'evt-offline';
  if (e.includes('online'))  return 'evt-online';
  if (e.includes('alarm')||e.includes('sos')||e.includes('speed')) return 'evt-alarm';
  return 'evt-default';
}

// Row helper
function rRow(dot, label, val, valCls) {
  return `<div class="row-item">
    <div class="row-label"><span class="dot ${dot}"></span>${label}</div>
    <div class="row-value ${valCls}">${val}</div>
  </div>`;
}

// Chart helpers
function barOpts() {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{display:false}, tooltip:{ callbacks:{label:c=>` ${c.raw.toLocaleString()} km`} } },
    scales:{
      y:{ beginAtZero:true, grid:{color:'rgba(0,0,0,0.04)'}, ticks:{callback:v=>v.toLocaleString()+' km',font:{size:11}} },
      x:{ grid:{display:false}, ticks:{font:{size:11}} }
    }
  };
}
function lineOpts() {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{display:false}, tooltip:{ callbacks:{label:c=>` ${c.parsed.y.toLocaleString()} km`} } },
    scales:{
      y:{ beginAtZero:true, grid:{color:'rgba(0,0,0,0.04)'}, ticks:{callback:v=>v.toLocaleString()+' km',font:{size:11}} },
      x:{ grid:{display:false}, ticks:{font:{size:11}} }
    }
  };
}

function newChart(tileId, canvasId, type, data, options) {
  if (charts[tileId]) { try { charts[tileId].destroy(); } catch{} }
  const ctx = document.getElementById(canvasId);
  if (!ctx) return;
  charts[tileId] = new Chart(ctx, { type, data, options: { ...options, responsive:true, maintainAspectRatio:false } });
}

function cap(s) { return s ? s.charAt(0).toUpperCase()+s.slice(1).toLowerCase() : ''; }
function escHtml(s) {
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ════════════════════════════════════════════════
// LAYOUT RENDERING
// ════════════════════════════════════════════════
function renderLayout() {
  const grid = document.getElementById('tileGrid');

  // Destroy all existing charts before re-rendering
  Object.keys(charts).forEach(id => { try { charts[id].destroy(); } catch{} });
  charts = {};

  grid.innerHTML = '';

  layout.forEach((item, idx) => {
    const def = TILE_DEFS[item.tileId];
    if (!def) return;

    const tile = document.createElement('div');
    tile.className = 'tile' + (item.size === 'wide' ? ' wide' : '');
    tile.dataset.idx = idx;
    tile.dataset.tileId = item.tileId;

    tile.innerHTML = `
      <div class="tile-header">
        <div class="tile-title" id="title_${item.tileId}">${def.icon} ${def.label}</div>
        <div class="tile-controls">
          <div class="drag-handle" role="button" aria-label="Drag to reorder tile" tabindex="0" title="Drag to reorder">⠿</div>
          <button class="tile-ctrl-btn resize-btn" aria-label="Toggle tile width" title="Toggle width" onclick="resizeTile('${item.tileId}')">↔</button>
          <button class="tile-ctrl-btn remove-btn" aria-label="Remove ${def.label} tile" title="Remove" onclick="removeTile('${item.tileId}')">×</button>
        </div>
      </div>
      <div class="tile-body" id="body_${item.tileId}" role="region" aria-labelledby="title_${item.tileId}"></div>
    `;

    grid.appendChild(tile);
    renderTileContent(item.tileId);
  });

  // Re-init sortable if in edit mode
  if (editMode) initSortable();
}

function renderTileContent(tileId) {
  const def = TILE_DEFS[tileId];
  const body = document.getElementById(`body_${tileId}`);
  if (!def || !body) return;

  // Check if any required data module failed — surface the real error
  const errors = cache.errors || {};
  const failed = (def.needs || []).find(n => errors[n]);
  if (failed) {
    body.innerHTML = `
      <div class="tile-error">
        <div class="tile-error__icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></div>
        <div class="tile-error__title">Could not load data</div>
        <div class="tile-error__msg">${escHtml(errors[failed])}</div>
        <button class="tile-error__retry" onclick="refresh()">Retry</button>
      </div>`;
    return;
  }

  try { def.render(body, tileId); }
  catch(e) {
    body.innerHTML = `
      <div class="tile-error">
        <div class="tile-error__icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></div>
        <div class="tile-error__title">Render error</div>
        <div class="tile-error__msg">${escHtml(e.message)}</div>
      </div>`;
  }
}

function renderAllTileContents() {
  layout.forEach(item => renderTileContent(item.tileId));
}

// ════════════════════════════════════════════════
// EDIT MODE
// ════════════════════════════════════════════════
function toggleEditMode() {
  editMode = !editMode;
  document.body.classList.toggle('edit-mode', editMode);
  document.getElementById('editBar').classList.toggle('visible', editMode);
  const editBtn = document.getElementById('editBtn');
  editBtn.classList.toggle('active', editMode);
  editBtn.setAttribute('aria-pressed', editMode ? 'true' : 'false');
  editBtn.innerHTML = editMode
    ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg> Done`
    : `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Customize`;

  if (editMode) initSortable();
  else if (sortable) { sortable.destroy(); sortable = null; }
}

function initSortable() {
  if (sortable) { sortable.destroy(); sortable = null; }
  sortable = Sortable.create(document.getElementById('tileGrid'), {
    animation: 200,
    handle: '.drag-handle',
    draggable: '.tile',
    ghostClass: 'sortable-ghost',
    chosenClass: 'sortable-chosen',
    onEnd(evt) {
      const moved = layout.splice(evt.oldIndex, 1)[0];
      layout.splice(evt.newIndex, 0, moved);
      saveLayout();
      // Re-render to fix canvas contexts after drag
      renderLayout();
    }
  });
}

function removeTile(tileId) {
  layout = layout.filter(t => t.tileId !== tileId);
  saveLayout();
  if (charts[tileId]) { try { charts[tileId].destroy(); } catch {} delete charts[tileId]; }
  const tile = document.querySelector(`[data-tile-id="${tileId}"]`);
  if (tile) tile.remove();
}

function resizeTile(tileId) {
  const item = layout.find(t => t.tileId === tileId);
  if (!item) return;
  item.size = item.size === 'wide' ? 'normal' : 'wide';
  saveLayout();
  const tile = document.querySelector(`[data-tile-id="${tileId}"]`);
  if (tile) {
    tile.classList.toggle('wide', item.size === 'wide');
    if (charts[tileId]) charts[tileId].resize();
  }
}

// ════════════════════════════════════════════════
// ADD TILE DRAWER
// ════════════════════════════════════════════════
function openDrawer() {
  const palette = document.getElementById('tilePalette');
  const active = new Set(layout.map(t => t.tileId));
  palette.innerHTML = Object.entries(TILE_DEFS).map(([id, def]) => `
    <div class="palette-item${active.has(id)?' already-added':''}" onclick="addTile('${id}')">
      <div class="palette-item-name">${def.icon} ${def.label}</div>
      <div class="palette-item-desc">${def.desc}</div>
      <div class="palette-item-size">Default: ${def.defaultSize === 'wide' ? 'Full width' : 'Half width'} ${active.has(id)?'· Already added':''}</div>
    </div>
  `).join('');
  document.getElementById('drawerOverlay').classList.add('visible');
  setTimeout(() => document.getElementById('drawer').classList.add('open'), 10);
}

function closeDrawer() {
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('visible');
}

function addTile(tileId) {
  if (layout.find(t => t.tileId === tileId)) return;
  const def = TILE_DEFS[tileId];
  layout.push({ tileId, size: def.defaultSize });
  saveLayout();
  renderLayout();
  closeDrawer();
}

// ════════════════════════════════════════════════
// SERVER AUTO-DETECTION
// ════════════════════════════════════════════════
const KNOWN_SERVERS = [
  { url: 'https://api.eu.navixy.com', label: 'EU' },
  { url: 'https://api.us.navixy.com', label: 'US' },
];
const SERVER_CACHE_KEY = 'nvx_server_' + HASH.slice(0, 8);

async function detectServer() {
  // 1. Explicit ?server= param always wins — skip detection
  if (SERVER) {
    BASE = `${SERVER}/v2`;
    return null;
  }

  // 2. Use cached value from this session
  const cached = sessionStorage.getItem(SERVER_CACHE_KEY);
  if (cached) {
    SERVER = cached;
    BASE = `${SERVER}/v2`;
    return null; // user info still needs a separate call
  }

  // 3. Probe known servers in parallel — first successful auth wins
  const probe = async ({ url, label }) => {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000);
    try {
      const r = await fetch(`${url}/v2/user/get_info`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hash: HASH }),
        signal: controller.signal
      });
      const d = await r.json();
      if (!d.success) throw new Error(`${label}: auth failed`);
      return { url, label, userInfo: d.user_info };
    } finally {
      clearTimeout(timeoutId);
    }
  };

  try {
    const result = await Promise.any(KNOWN_SERVERS.map(probe));
    SERVER = result.url;
    BASE   = `${SERVER}/v2`;
    sessionStorage.setItem(SERVER_CACHE_KEY, SERVER);
    return result; // caller can use .userInfo and .label
  } catch {
    // All probes failed — fall back to EU and let normal error handling take over
    SERVER = KNOWN_SERVERS[0].url;
    BASE   = `${SERVER}/v2`;
    return null;
  }
}

function showServerBadge(label) {
  const el = document.getElementById('serverBadge');
  if (el) el.textContent = label;
}

// ════════════════════════════════════════════════
// USER INFO
// ════════════════════════════════════════════════
async function loadUserInfo() {
  try {
    const d = await api('/user/get_info');
    document.getElementById('userEmail').textContent = d.user_info?.login || d.user_info?.email || '—';
  } catch(e) {
    console.warn('loadUserInfo:', e.message);
    document.getElementById('userEmail').textContent = '(auth error)';
  }
}

// ════════════════════════════════════════════════
// MAIN REFRESH
// ════════════════════════════════════════════════
async function refresh() {
  if (isLoading || document.hidden) return;
  isLoading = true;
  const btn = document.getElementById('refreshBtn');
  const ico = document.getElementById('refreshIcon');
  btn.disabled = true;
  ico.classList.add('spinning');
  document.getElementById('errorBanner').classList.remove('visible');

  // Show skeleton placeholders only on the very first load
  if (lastRefreshTime === 0) showSkeletons();

  try {
    await fetchAll();
    renderAllTileContents();
    lastRefreshTime = Date.now();
    document.getElementById('lastRefreshLabel').textContent = 'Updated ' + new Date().toLocaleTimeString();
  } catch(e) {
    document.getElementById('errorMsg').textContent = `Failed to load data: ${e.message}`;
    document.getElementById('errorBanner').classList.add('visible');
    // Clear skeleton state on first-load failure so tiles show error state
    if (lastRefreshTime === 0) renderAllTileContents();
  } finally {
    isLoading = false;
    btn.disabled = false;
    ico.classList.remove('spinning');
  }
}

// ════════════════════════════════════════════════
// BOOTSTRAP
// ════════════════════════════════════════════════
if (!HASH) {
  document.getElementById('setupScreen').classList.add('visible');
  const allParams = [...params.entries()];
  const dbg = document.getElementById('debugPanel');
  if (allParams.length > 0) {
    dbg.innerHTML = `<div style="background:#fff8e1;border:1px solid #ffe082;border-radius:10px;padding:16px 20px;font-size:13px">
      <strong style="color:#e65100">⚠ URL parameters detected but no recognised key found</strong><br><br>
      ${allParams.map(([k,v])=>`<code>${escHtml(k)}</code> = ${k.toLowerCase().match(/hash|key|token/)?'••••••••':escHtml(v)}`).join('<br>')}
    </div>`;
  } else {
    dbg.innerHTML = `<div style="background:#f3f3f3;border:1px solid #e0e0e0;border-radius:10px;padding:14px 20px;font-size:13px;color:#757575">
      No URL parameters received. Ensure <strong>Session key</strong> is enabled in GET parameters.
    </div>`;
  }
} else {
  // Remove history stored under old/stale session hashes
  Object.keys(localStorage)
    .filter(k => k.startsWith('nvx_conn_history_') && k !== HISTORY_KEY)
    .forEach(k => localStorage.removeItem(k));

  connHistory = loadConnHistory();
  layout = loadLayout() || DEFAULT_LAYOUT.map(t => ({ ...t }));
  document.getElementById('dashboardRoot').style.display = 'block';
  renderLayout();

  // Detect server first, then start loading data
  detectServer().then(result => {
    if (result) {
      // Detection gave us user info for free — no extra call needed
      const login = result.userInfo?.login || result.userInfo?.email || '—';
      document.getElementById('userEmail').textContent = login;
      showServerBadge(result.label);
    } else {
      // Used cache or explicit param — show badge from stored value
      const match = KNOWN_SERVERS.find(s => s.url === SERVER);
      if (match) showServerBadge(match.label);
      loadUserInfo();
    }
    refresh();
    setInterval(refresh, 60000);
    // Catch up if the tab was hidden and the interval fired while invisible
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && Date.now() - lastRefreshTime > 60_000) refresh();
    });
  });
}
</script>
</body>
</html>
